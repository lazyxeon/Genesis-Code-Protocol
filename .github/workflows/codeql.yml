name: CodeQL

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '0 4 * * 0'

permissions:
  contents: read
  security-events: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Optional: quick tokenize gate; shows exact file/line if syntax/encoding breaks
      - name: Python tokenize gate
        run: |
          python - <<'PY'
          import sys, tokenize, pathlib
          bad=[]
          for p in pathlib.Path('.').rglob('*.py'):
              try:
                  with open(p,'rb') as f:
                      for _ in tokenize.tokenize(f.readline): pass
              except Exception as e:
                  bad.append((str(p), e))
          if bad:
              print("Syntax/encoding errors:")
              for path, err in bad:
                  print(f" - {path}: {err}")
              sys.exit(1)
          print("All .py files tokenized OK")
          PY

      - uses: github/codeql-action/init@v3
        with:
          languages: python
          tools: latest
          config-file: .github/codeql/codeql-config.yml

      - uses: github/codeql-action/analyze@v3
