name: CodeQL

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '0 4 * * 0'

permissions:
  contents: read
  security-events: read

jobs:
  analyze:
    permissions:
      contents: read
      security-events: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - name: Python tokenize gate
        run: |
          python - <<'PY'
          import sys, tokenize, pathlib
          bad=[]
            # Walk all Python files; fail if any cannot tokenize.
          for p in pathlib.Path('.').rglob('*.py'):
              try:
                  with open(p,'rb') as f:
                      for _ in tokenize.tokenize(f.readline): pass
              except Exception as e:
                  bad.append((str(p), e))
          if bad:
              print("Syntax/encoding errors:")
              for path, err in bad:
                  print(f" - {path}: {err}")
              sys.exit(1)
          print("All .py files tokenized OK")
          PY

      - uses: github/codeql-action/init@e2e741e6482c84b120b2c2b935e8f4a6e5fb164e
        with:
          languages: python
          tools: latest
          config-file: .github/codeql/codeql-config.yml

      - uses: github/codeql-action/analyze@e2e741e6482c84b120b2c2b935e8f4a6e5fb164e
